harnessApiVersion: '1.0'
type: KUBERNETES
advancedConfig: |-
    # Enter your Controller YAML spec below.
    #
    # Supported Controllers:
    #   ReplicationController
    #   Deployment
    #   ReplicaSet
    #   StatefulSet
    #   DaemonSet
    #
    # Placeholders:
    #
    # Required: ${DOCKER_IMAGE_NAME}
    #   - Replaced with the Docker image name and tag
    #
    # Optional: ${CONTAINER_NAME}
    #   - Replaced with a container name based on the image name
    #
    # Optional: ${CONFIG_MAP_NAME}
    #   - Replaced with the ConfigMap name
    #
    # Optional: ${SECRET_NAME}
    #   - Replaced with the name of the generated image pull
    #     secret when pulling from a private Docker registry
    #
    # Harness will set the controller name, namespace,
    # selector labels, and number of replicas.
    #
    # Service variables will be merged into environment
    # variables for all containers, overriding values if
    # the name is the same.
    #
    # ---
    apiVersion: extensions/v1beta1
    kind: Deployment
    metadata:
        name: nginx-ingress-controller
        labels:
            k8s-app: nginx-ingress-controller
    spec:
        replicas: 1
        selector:
            matchLabels:
                k8s-app: nginx-ingress-controller
        template:
            metadata:
                labels:
                    k8s-app: nginx-ingress-controller
            spec:
                # hostNetwork makes it possible to use ipv6 and to preserve the source IP correctly regardless of docker configuration
                # however, it is not a hard dependency of the nginx-ingress-controller itself and it may cause issues if port 10254 already is taken on the host
                # that said, since hostPort is broken on CNI (https://github.com/kubernetes/kubernetes/issues/31307) we have to use hostNetwork where CNI is used
                # like with kubeadm
                # hostNetwork: true
                terminationGracePeriodSeconds: 60
                containers:
                  - image: ${DOCKER_IMAGE_NAME}
                    name: nginx-ingress-controller
                    readinessProbe:
                        httpGet:
                            path: /healthz
                            port: 10254
                            scheme: HTTP
                    livenessProbe:
                        httpGet:
                            path: /healthz
                            port: 10254
                            scheme: HTTP
                        initialDelaySeconds: 10
                        timeoutSeconds: 1
                    ports:
                      - containerPort: 80
                        hostPort: 80
                      - containerPort: 443
                        hostPort: 443
                    env:
                          - name: POD_NAME
                            valueFrom:
                                fieldRef:
                                    fieldPath: metadata.name
                          - name: POD_NAMESPACE
                            valueFrom:
                                fieldRef:
                                    fieldPath: metadata.namespace
                    args:
                      - /nginx-ingress-controller
                        - --default-backend-service=$(POD_NAMESPACE)/puneet-ingress-app-default-backend-prod
                        - --configmap=$(POD_NAMESPACE)/${CONFIG_MAP_NAME}
                        - --default-ssl-certificate=$(POD_NAMESPACE)/${CONFIG_MAP_NAME}
